# Hot reload configuration
. {
    reload
    erratic
}

# Classic DNS on 53, forwarding to an upstream
.:{$DNS_PORT} {
    forward . {$UPSTREAM_SERVERS} {
       tls_servername {$UPSTREAM_NAME}
       health_check 5s
    }

    cache 86400

    log
    errors
}

# Couldn't make this shit to build
#.:{$DNS_PORT} {
#  unbound
#}

# DoT on 853, forwarding to an upstream
tls://.:{$TLS_PORT} {
  tls /data/certificates/{$DOMAIN}.crt /data/certificates/{$DOMAIN}.key certificates/{$DOMAIN}.issuer.crt

  forward . {$UPSTREAM_SERVERS} {
    tls_servername {$UPSTREAM_NAME}
    health_check 5s
  }
  cache 86400

  log
  errors
}
